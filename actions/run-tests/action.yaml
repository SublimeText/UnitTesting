name: Run UnitTesting
description: Run UnitTesting
inputs:
  package-name:
    description: Package name. Derived from repo name if empty.
    default: ''
  coverage:
    description: Run with coverage report
    required: true
    default: false
  codecov-upload:
    description: Upload coverage report to codecov.
    required: true
    default: false
runs:
  using: 'composite'
  steps:
    - run: |
        REMOTEURL=$(git config --get remote.origin.url || true)
        if [[ "REMOTEURL" =~ ^https://github.com/ ]]; then
          REPO=${${REMOTEURL#https://github.com/}%\.git}
        else
          REPO="$GITHUB_REPOSITORY"
        fi
        PACKAGE="${{ inputs.package-name }}"
        PACKAGE="${PACKAGE:-${REPO#*/}}"

        if [ "${{ inputs.coverage }}" == "true" ]; then
          python3 "$GITHUB_ACTION_PATH/../../scripts/run_tests.py" "$PACKAGE" --coverage
        else
          python3 "$GITHUB_ACTION_PATH/../../scripts/run_tests.py" "$PACKAGE"
        fi
      shell: bash
    - if: inputs.codecov == 'true'
      run: |
        if [ -f ./.coverage ]; then
          pip3 install coverage==4.5.4
          coverage xml -o coverage.xml
        fi
      shell: bash
    - if: inputs.codecov == 'true'
      uses: codecov/codecov-action@v2
