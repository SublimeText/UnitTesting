# NOTE: These params need to mirror exactly those of ci.ps1
[CmdletBinding()]
param(
    [Parameter(Mandatory = $false, Position = 0)]
    [string]$command,
    [Parameter(Mandatory = $false)]
    [switch] $coverage
)


# Scripts other than the bootstrapper are located here.
$global:UnitTestingPowerShellScriptsDirectory = $env:TEMP

if (!$env:UNITTESTING_BOOTSTRAPPED) {
    write-output "[UnitTesting] bootstrapping environment..."

    # UTF8 encoding without preamble.
    $local:utf8 = [System.Text.UTF8Encoding]::new($false)

    # Files encoded in base64 encoding. They need to be unpacked before they can be used.
    # !!! Every time they change, they need to be regenerated and copied here. !!!
    $local:encodedDependencies = @(
        'utils.ps1@@@CmZ1bmN0aW9uIGVuc3VyZUNyZWF0ZURpcmVjdG9yeSB7CiAgICBwYXJhbShbc3RyaW5nXSRQYXRoKQogICAgW3ZvaWRdKG5ldy1pdGVtIC1pdGVtdHlwZSBkICIkUGF0aCIgLWZvcmNlIC1lcnJvcmFjdGlvbiBzdG9wKQp9CgpmdW5jdGlvbiBlaXRoZXJPciB7CiAgICBwYXJhbSgkTGVmdCwgJFJpZ2h0KQogICAgaWYgKCRMZWZ0KSB7ICRMZWZ0IH0gZWxzZSB7ICRSaWdodCB9Cn0KCmZ1bmN0aW9uIG51bGxPciB7CiAgICBwYXJhbSgkTGVmdCwgJFJpZ2h0KQogICAgaWYgKCRMZWZ0IC1lcSAkbnVsbCkgeyAkTGVmdCB9IGVsc2UgeyAkUmlnaHQgfQp9CgpmdW5jdGlvbiB0b0xvZ01lc3NhZ2UgewogICAgcGFyYW0oW3N0cmluZ10kY29udGVudCkKICAgICJbVW5pdFRlc3RpbmddICRjb250ZW50Igp9CgpmaWx0ZXIgbG9nVmVyYm9zZSB7CiAgICBwYXJhbShbc3RyaW5nXSRtZXNzYWdlKQogICAgd3JpdGUtdmVyYm9zZSAodG9Mb2dNZXNzYWdlIChlaXRoZXJPciAkXyAkbWVzc2FnZSkpCn0KCmZpbHRlciBsb2dXYXJuaW5nIHsKICAgIHBhcmFtKFtzdHJpbmddJG1lc3NhZ2UpCiAgICB3cml0ZS13YXJuaW5nICh0b0xvZ01lc3NhZ2UgKGVpdGhlck9yICRfICRtZXNzYWdlKSkKfQoKZnVuY3Rpb24gZW5zdXJlQ29weURpcmVjdG9yeUNvbnRlbnRzIHsKICAgIHBhcmFtKFtzdHJpbmddJFBhdGgsIFtzdHJpbmddJERlc3RpbmF0aW9uKQogICAgY29weS1pdGVtICIkUGF0aFwqIiAtcmVjdXJzZSAtZm9yY2UgJERlc3RpbmF0aW9uIC1lcnJvcmFjdGlvbiBzdG9wCn0KCmZ1bmN0aW9uIGVuc3VyZVJlbW92ZURpcmVjdG9yeSB7CiAgICBwYXJhbShbc3RyaW5nXSRQYXRoKQogICAgaWYgKFtTeXN0ZW0uSU8uUGF0aC5GaWxlXS5FeGlzdHMoKGNvbnZlcnQtcGF0aCAkUGF0aCkpKSB7CiAgICAgICAgdGhyb3cgImV4cGVjdGVkIGEgZGlyZWN0b3J5LCBnb3QgYSBmaWxlOiAkUGF0aCIKICAgIH0KICAgIHJlbW92ZS1pdGVtICIkUGF0aCIgLXJlY3Vyc2UgLWZvcmNlIC1lcnJvcmFjdGlvbiBzdG9wCn0KCmZ1bmN0aW9uIGdpdEZldGNoTGF0ZXN0VGFnRnJvbVJlcG9zaXRvcnkgewogICAgcGFyYW0oW3N0cmluZ10kVXJsVG9SZXBvc2l0b3J5KQogICAgZ2l0IGxzLXJlbW90ZSAtLXRhZ3MgIiRVcmxUb1JlcG9zaXRvcnkiIHwgJXskXyAtcmVwbGFjZSAiLiovKC4qKSQiLCAnJDEnfSBgCiAgICAgICAgfCB3aGVyZS1vYmplY3QgeyRfIC1ub3RtYXRjaCAiXF4ifSB8JXtbU3lzdGVtLlZlcnNpb25dJF99IGAKICAgICAgICB8IHNvcnQgfCBzZWxlY3Qtb2JqZWN0IC1sYXN0IDEgfCAleyAiJF8iIH0KfQoKZnVuY3Rpb24gZ2l0Q2xvbmVUYWcgewogICAgcGFyYW0oW3N0cmluZ10kVGFnLCBbc3RyaW5nXSRSZXBvc2l0b3J5VXJsLCBbc3RyaW5nXSREZXN0aW5hdGlvbikKICAgIGdpdCBjbG9uZSAtLXF1aWV0IC0tZGVwdGggMSAtLWJyYW5jaD0kVGFnICRSZXBvc2l0b3J5VXJsICIkRGVzdGluYXRpb24iIDI+JG51bGwKfQoKZnVuY3Rpb24gZ2l0R2V0SGVhZFJldmlzaW9uTmFtZSB7CiAgICBwYXJhbShbc3RyaW5nXSRSZXBvc2l0b3J5RGlyZWN0b3J5KQogICAgZ2l0IC1DICRSZXBvc2l0b3J5RGlyZWN0b3J5IHJldi1wYXJzZSBIRUFECn0KCmZ1bmN0aW9uIGdldExhdGVzdFVuaXRUZXN0aW5nQnVpbGRUYWcgewogICAgcGFyYW0oW3N0cmluZ10kVGFnLCBbc3RyaW5nXSRTdWJsaW1lVGV4dFZlcnNpb24sIFtzdHJpbmddJFVybFRvVW5pdFRlc3RpbmcpCiAgICAkcmVzdWx0ID0gJFRhZwogICAgaWYgKFtzdHJpbmddOjpJc051bGxPckVtcHR5KCRUYWcpKXsKICAgICAgICBpZiAoJFN1YmxpbWVUZXh0VmVyc2lvbiAtZXEgMikgewogICAgICAgICAgICAkcmVzdWx0ID0gJzAuMTAuNicKICAgICAgICB9IGVsc2VpZiAoJFN1YmxpbWVUZXh0VmVyc2lvbiAtZXEgMykgewogICAgICAgICAgICAkcmVzdWx0ID0gZ2l0RmV0Y2hMYXRlc3RUYWdGcm9tUmVwb3NpdG9yeSAkVXJsVG9Vbml0VGVzdGluZwogICAgICAgIH0KICAgIH0KICAgICRyZXN1bHQKfQoKZnVuY3Rpb24gZ2V0UmVwb3NpdG9yeVRhZyB7CiAgICBwYXJhbShbc3RyaW5nXSRQcmVmZXJyZWRUYWcsIFtzdHJpbmddJFJlcG9zaXRvcnlVcmwpCiAgICBpZiAoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJFByZWZlcnJlZFRhZykpIHsgZ2l0RmV0Y2hMYXRlc3RUYWdGcm9tUmVwb3NpdG9yeSAkUmVwb3NpdG9yeVVybCB9CiAgICBlbHNlIHsgJFByZWZlcnJlZFRhZyB9Cn0KCmZ1bmN0aW9uIGNsb25lUmVwb3NpdG9yeVRhZyB7CiAgICBwYXJhbShbc3RyaW5nXSRQcmVmZXJyZWRUYWcsIFtzdHJpbmddJFJlcG9zaXRvcnlVcmwsIFtzdHJpbmddJERlc3RpbmF0aW9uKQogICAgJFRhZyA9IGdldFJlcG9zaXRvcnlUYWcgJFByZWZlcnJlZFRhZyAkUmVwb3NpdG9yeVVybAogICAgbG9nVmVyYm9zZSAiY2xvbmluZyAkKHNwbGl0LXBhdGggJFJlcG9zaXRvcnlVcmwgLWxlYWYpIHRhZzogJFRhZyBpbnRvICREZXN0aW5hdGlvbi4uLiIKICAgIGdpdENsb25lVGFnICRUYWcgJFJlcG9zaXRvcnlVcmwgJERlc3RpbmF0aW9uCiAgICBnaXRHZXRIZWFkUmV2aXNpb25OYW1lICREZXN0aW5hdGlvbiB8IGxvZ1ZlcmJvc2UKICAgIGxvZ1ZlcmJvc2UgIiIKfQoKZnVuY3Rpb24gZ2V0TGF0ZXN0Q29sb3JTY2hlbWVVbml0VGFnIHsKICAgIHBhcmFtKFtzdHJpbmddJFRhZywgW3N0cmluZ10kVXJsVG9Db2xvclNjaGVtZVVuaXQpCiAgICBpZiAoW3N0cmluZ106OklzTnVsbE9yRW1wdHkoJFRhZykpIHsgZ2l0RmV0Y2hMYXRlc3RUYWdGcm9tUmVwb3NpdG9yeSAkVXJsVG9Db2xvclNjaGVtZVVuaXQgfQogICAgZWxzZSB7ICRUYWcgfQp9CgpmdW5jdGlvbiBlbnN1cmVDcmVhdGVEaXJlY3RvcnlKdW5jdGlvbiB7CiAgICBwYXJhbShbc3RyaW5nXSRMaW5rLCBbc3RyaW5nXSRUYXJnZXQpCiAgICBjbWQuZXhlIC9jIG1rbGluayAvSiAiJExpbmsiICIkVGFyZ2V0IgogICAgaWYgKCRMQVNURVhJVENPREUgLW5lIDApIHsgdGhyb3cgImNvdWxkIG5vdCBjcmVhdGUgZGlyZWN0b3J5IGp1bmN0aW9uIGF0ICRMaW5rIHRvICRUYXJnZXQiIH0KfQoKZnVuY3Rpb24gZW5zdXJlVmFsdWUgewogICAgcGFyYW0oJFZhbHVlLCBbc3RyaW5nXSRQYXR0ZXJuPSdeLiokJywgW3N0cmluZ10kTWVzc2FnZT0kbnVsbCkKICAgIGlmKCgkVmFsdWUgLWVxICRudWxsKSAtb3IgKCRWYWx1ZSAtbm90bWF0Y2ggJFBhdHRlcm4pKSB7CiAgICAgICAgdGhyb3cgKGVpdGhlck9yICRNZXNzYWdlICJ2YWx1ZSBpcyBudWxsIG9yIHVuZXhwZWN0ZWQgKGV4cGVjdGVkIG1hdGNoOiAkUGF0dGVybjsgZ290OiAkVmFsdWUpIikKICAgIH0KICAgICRWYWx1ZQp9CgpmdW5jdGlvbiBwYXRoRXhpc3RzIHsKICAgIHBhcmFtKFtzdHJpbmddJFBhdGgsIFtzd2l0Y2hdJE5lZ2F0ZT0kRmFsc2UpCiAgICBpZiAoISROZWdhdGUpIHsgdGVzdC1wYXRoICRQYXRoIH0gZWxzZSB7ICEodGVzdC1wYXRoICRQYXRoKSB9Cn0KCmZ1bmN0aW9uIGluc3RhbGxQYWNrYWdlRm9yU3VibGltZVRleHRWZXJzaW9uM0lmTm90UHJlc2VudCB7CiAgICBwYXJhbShbc3RyaW5nXSRQYXRoLCBbc3RyaW5nXSRQcmVmZXJyZWRUYWcsIFtzdHJpbmddJFJlcG9zaXRvcnlVcmwpCiAgICBpZiAoJElzU3VibGltZVRleHRWZXJzaW9uMyAtYW5kIChwYXRoRXhpc3RzIC1OZWdhdGUgJFBhdGgpKSB7CiAgICAgICAgY2xvbmVSZXBvc2l0b3J5VGFnICRQcmVmZXJyZWRUYWcgJFJlcG9zaXRvcnlVcmwgJFBhdGgKICAgIH0KfQ==',
        'ci.ps1@@@W0NtZGxldEJpbmRpbmcoKV0KcGFyYW0oCiAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSwgUG9zaXRpb24gPSAwKV0KICAgIFtzdHJpbmddJGNvbW1hbmQsCiAgICBbUGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldCiAgICBbc3dpdGNoXSAkY292ZXJhZ2UKKQoKIyBUT0RPOiBCb290c3RyYXAgdGhlIGJvb3RzdHJhcHBlci4gU2VlIGFwcHZleW9yLnBzMS4KJGdsb2JhbDpVbml0VGVzdGluZ1Bvd2VyU2hlbGxTY3JpcHRzRGlyZWN0b3J5ID0gJGVudjpURU1QCgouICRVbml0VGVzdGluZ1Bvd2VyU2hlbGxTY3JpcHRzRGlyZWN0b3J5XGNpX2NvbmZpZy5wczEKLiAkVW5pdFRlc3RpbmdQb3dlclNoZWxsU2NyaXB0c0RpcmVjdG9yeVx1dGlscy5wczEKCmZ1bmN0aW9uIEJvb3RzdHJhcCB7CiAgICBbQ21kbGV0QmluZGluZygpXQogICAgcGFyYW0oW3N3aXRjaF0gJHdpdGhfY29sb3Jfc2NoZW1lX3VuaXQpCiAgICAKICAgIGVuc3VyZUNyZWF0ZURpcmVjdG9yeSAkU3VibGltZVRleHRQYWNrYWdlc0RpcmVjdG9yeQoKICAgICMgQ29weSBwbHVnaW4gZmlsZXMgdG8gUGFja2FnZXMvPFBhY2thZ2U+IGZvbGRlci4KICAgIGlmICgkUGFja2FnZVVuZGVyVGVzdE5hbWUgLWVxICRTeW1ib2xDb3B5QWxsKXsKICAgICAgICBsb2dWZXJib3NlICJjcmVhdGluZyBkaXJlY3RvcnkgZm9yIHBhY2thZ2UgdW5kZXIgdGVzdCBhdCAkUGFja2FnZVVuZGVyVGVzdFN1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3RvcnkuLi4iCiAgICAgICAgZW5zdXJlQ3JlYXRlRGlyZWN0b3J5ICRQYWNrYWdlVW5kZXJUZXN0U3VibGltZVRleHRQYWNrYWdlc0RpcmVjdG9yeQogICAgICAgIGxvZ1ZlcmJvc2UgImNvcHlpbmcgY3VycmVudCBkaXJlY3RvcnkgY29udGVudHMgdG8gJFBhY2thZ2VVbmRlclRlc3RTdWJsaW1lVGV4dFBhY2thZ2VzRGlyZWN0b3J5Li4uIgogICAgICAgICMgVE9ETzogY3JlYXRlIGp1bmN0aW9ucyBmb3IgYWxsIHBhY2thZ2VzLgogICAgICAgIGVuc3VyZUNvcHlEaXJlY3RvcnlDb250ZW50cyAuICRTdWJsaW1lVGV4dFBhY2thZ2VzRGlyZWN0b3J5CiAgICB9IGVsc2UgewogICAgICAgIGxvZ1ZlcmJvc2UgImNyZWF0aW5nIGRpcmVjdG9yeSBqdW5jdGlvbiB0byBwYWNrYWdlIHVuZGVyIHRlc3QgYXQgJFBhY2thZ2VVbmRlclRlc3RTdWJsaW1lVGV4dFBhY2thZ2VzRGlyZWN0b3J5Li4uIgogICAgICAgIGVuc3VyZUNyZWF0ZURpcmVjdG9yeUp1bmN0aW9uICRQYWNrYWdlVW5kZXJUZXN0U3VibGltZVRleHRQYWNrYWdlc0RpcmVjdG9yeSAuCiAgICB9CgogICAgIyBDbG9uZSBVbml0VGVzdGluZyBpbnRvIFBhY2thZ2VzL1VuaXRUZXN0aW5nLgogICAgaWYgKHBhdGhFeGlzdHMgLU5lZ2F0ZSAkVW5pdFRlc3RpbmdTdWJsaW1lVGV4dFBhY2thZ2VzRGlyZWN0b3J5KSB7CiAgICAgICAgJFVOSVRURVNUSU5HX1RBRyA9IGdldExhdGVzdFVuaXRUZXN0aW5nQnVpbGRUYWcgJGVudjpVTklUVEVTVElOR19UQUcgJFN1YmxpbWVUZXh0VmVyc2lvbiAkVW5pdFRlc3RpbmdSZXBvc2l0b3J5VXJsCiAgICAgICAgbG9nVmVyYm9zZSAiZG93bmxvYWQgVW5pdFRlc3RpbmcgdGFnOiAkVU5JVFRFU1RJTkdfVEFHIgogICAgICAgIGdpdENsb25lVGFnICRVTklUVEVTVElOR19UQUcgVW5pdFRlc3RpbmdSZXBvc2l0b3J5VXJsICRVbml0VGVzdGluZ1N1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3RvcnkKICAgICAgICBnaXRHZXRIZWFkUmV2aXNpb25OYW1lICRVbml0VGVzdGluZ1N1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3RvcnkgfCBsb2dWZXJib3NlCiAgICAgICAgbG9nVmVyYm9zZSAiIgogICAgfQoKICAgICMgQ2xvbmUgY292ZXJhZ2UgcGx1Z2luIGludG8gUGFja2FnZXMvY292ZXJhZ2UuCiAgICBpbnN0YWxsUGFja2FnZUZvclN1YmxpbWVUZXh0VmVyc2lvbjNJZk5vdFByZXNlbnQgJENvdmVyYWdlU3VibGltZVRleHRQYWNrYWdlc0RpcmVjdG9yeSAkZW52OkNPVkVSQUdFX1RBRyAkQ292ZXJhZ2VSZXBvc2l0b3J5VXJsCgogICAgJiAiJFVuaXRUZXN0aW5nU3VibGltZVRleHRQYWNrYWdlc0RpcmVjdG9yeVxzYmluXGluc3RhbGxfc3VibGltZV90ZXh0LnBzMSIgLXZlcmJvc2UKfQoKZnVuY3Rpb24gSW5zdGFsbFBhY2thZ2VDb250cm9sIHsKICAgIHJlbW92ZS1pdGVtICRDb3ZlcmFnZVN1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3RvcnkgLUZvcmNlIC1SZWN1cnNlCiAgICAmICIkVW5pdFRlc3RpbmdTdWJsaW1lVGV4dFBhY2thZ2VzRGlyZWN0b3J5XHNiaW5caW5zdGFsbF9wYWNrYWdlX2NvbnRyb2wucHMxIiAtdmVyYm9zZQp9CgpmdW5jdGlvbiBJbnN0YWxsQ29sb3JTY2hlbWVVbml0IHsKICAgIGluc3RhbGxQYWNrYWdlRm9yU3VibGltZVRleHRWZXJzaW9uM0lmTm90UHJlc2VudCAkQ29sb3JTY2hlbWVVbml0U3VibGltZVRleHRQYWNrYWdlc0RpcmVjdG9yeSAkZW52OkNPTE9SX1NDSEVNRV9VTklUX1RBRyAkQ29sb3JTY2hlbWVVbml0UmVwb3NpdG9yeVVybAp9CgpmdW5jdGlvbiBJbnN0YWxsS2V5cHJlc3MgewogICAgaW5zdGFsbFBhY2thZ2VGb3JTdWJsaW1lVGV4dFZlcnNpb24zSWZOb3RQcmVzZW50ICRLZXlQcmVzc1N1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3RvcnkgJGVudjpLRVlQUkVTU19UQUcgJEtleVByZXNzUmVwb3NpdG9yeVVybAp9CgpmdW5jdGlvbiBSdW5UZXN0cyB7CiAgICBbQ21kbGV0QmluZGluZygpXQogICAgcGFyYW0oCiAgICAgICAgW3N3aXRjaF0gJHN5bnRheF90ZXN0LAogICAgICAgIFtzd2l0Y2hdICRjb2xvcl9zY2hlbWVfdGVzdCwKICAgICAgICBbc3dpdGNoXSAkY292ZXJhZ2UKICAgICkKCiAgICBpZiAoJHN5bnRheF90ZXN0KSB7CiAgICAgICAgJiAiJFVuaXRUZXN0aW5nU3VibGltZVRleHRQYWNrYWdlc0RpcmVjdG9yeVxzYmluXHJ1bl90ZXN0cy5wczEiICIkZW52OlBBQ0tBR0UiIC12ZXJib3NlIC1zeW50YXhfdGVzdAogICAgfSBlbHNlaWYgKCRjb2xvcl9zY2hlbWVfdGVzdCkgewogICAgICAgICYgIiRVbml0VGVzdGluZ1N1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3Rvcnlcc2JpblxydW5fdGVzdHMucHMxIiAiJGVudjpQQUNLQUdFIiAtdmVyYm9zZSAtY29sb3Jfc2NoZW1lX3Rlc3QKICAgIH0gZWxzZWlmICgkY292ZXJhZ2UpIHsKICAgICAgICAmICIkVW5pdFRlc3RpbmdTdWJsaW1lVGV4dFBhY2thZ2VzRGlyZWN0b3J5XHNiaW5ccnVuX3Rlc3RzLnBzMSIgIiRlbnY6UEFDS0FHRSIgLXZlcmJvc2UgLWNvdmVyYWdlCiAgICB9IGVsc2UgewogICAgICAgICYgIiRVbml0VGVzdGluZ1N1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3Rvcnlcc2JpblxydW5fdGVzdHMucHMxIiAiJGVudjpQQUNLQUdFIiAtdmVyYm9zZQogICAgfQoKICAgIHN0b3AtcHJvY2VzcyAtZm9yY2UgLXByb2Nlc3NuYW1lIHN1YmxpbWVfdGV4dCAtZWEgc2lsZW50bHljb250aW51ZQogICAgc3RhcnQtc2xlZXAgLXNlY29uZHMgMgp9Cgp0cnl7CiAgICBzd2l0Y2ggKCRjb21tYW5kKXsKICAgICAgICAnYm9vdHN0cmFwJyB7IEJvb3RzdHJhcCB9CiAgICAgICAgJ2luc3RhbGxfcGFja2FnZV9jb250cm9sJyB7IEluc3RhbGxQYWNrYWdlQ29udHJvbCB9CiAgICAgICAgJ2luc3RhbGxfY29sb3Jfc2NoZW1lX3VuaXQnIHsgSW5zdGFsbENvbG9yU2NoZW1lVW5pdCB9CiAgICAgICAgJ2luc3RhbGxfa2V5cHJlc3NzJyB7IEluc3RhbGxLZXlwcmVzcyB9CiAgICAgICAgJ3J1bl90ZXN0cycgeyBSdW5UZXN0cyAtY292ZXJhZ2U6JGNvdmVyYWdlIH0KICAgICAgICAncnVuX3N5bnRheF90ZXN0cycgeyBSdW5UZXN0cyAtc3ludGF4X3Rlc3R9CiAgICAgICAgJ3J1bl9jb2xvcl9zY2hlbWVfdGVzdHMnIHsgUnVuVGVzdHMgLWNvbG9yX3NjaGVtZV90ZXN0fQogICAgfQp9Y2F0Y2ggewogICAgdGhyb3cgJF8KfQ==',
        'ci_config.ps1@@@LiAkUFNTY3JpcHRSb290XHV0aWxzLnBzMQoKIyBXZSBtdXN0IHNldCBjb25zdGFudHMgb25seSBvbmNlLgppZiAoISRlbnY6VU5JVFRFU1RJTkdfQk9PVFNUUkFQUEVEKSB7CiAgICBmdW5jdGlvbiBsb2NhbDptYWtlR2xvYmFsQ29uc3RhbnQgewogICAgICAgIHBhcmFtKFtzdHJpbmddJE5hbWUsICRWYWx1ZSkKICAgICAgICBuZXctdmFyaWFibGUgLW5hbWUgJE5hbWUgLXZhbHVlICRWYWx1ZSAtb3B0aW9uIGNvbnN0YW50IC1zY29wZSBnbG9iYWwKICAgIH0KCiAgICBsb2dWZXJib3NlICJzZXR0aW5nIGdsb2JhbCBjb25zdGFudHMgYW5kIHZhcmlhYmxlcy4uLiIKCiAgICAjIFRPRE86IElmIHdlIHVzZWQgZGlyZWN0b3J5IGp1bmN0aW9ucyBoZXJlIHRvbywgd2Ugd291bGRuJ3QgbmVlZCB0aGlzPwogICAgIyBUaGlzIGNvbnN0YW50IG1lYW5zIHRoYXQgdGhlIGVudGlyZSBjb250ZW50cyBvZiB0aGUgc291cmNlIGRpcmVjdG9yeSBtdXN0IGJlIGNvcGllZCB0byB0aGUgdGFyZ2V0IGRpcmVjdG9yeS4KICAgIG1ha2VHbG9iYWxDb25zdGFudCBTeW1ib2xDb3B5QWxsICdfX2FsbF9fJwoKICAgIG1ha2VHbG9iYWxDb25zdGFudCBTdWJsaW1lVGV4dFZlcnNpb24gKGVuc3VyZVZhbHVlICRlbnY6U1VCTElNRV9URVhUX1ZFUlNJT04gJ14yfDMkJyAtbWVzc2FnZSAidGhlIGVudmlyb25tZW50IHZhcmlhYmxlIFNVQkxJTUVfVEVYVF9WRVJTSU9OIG11c3QgYmUgc2V0IHRvICcyJyBvciAnMyciKQogICAgbWFrZUdsb2JhbENvbnN0YW50IElzU3VibGltZVRleHRWZXJzaW9uMyAoJFN1YmxpbWVUZXh0VmVyc2lvbiAtZXEgMykKICAgIG1ha2VHbG9iYWxDb25zdGFudCBJc1N1YmxpbWVUZXh0VmVyc2lvbjIgKCRTdWJsaW1lVGV4dFZlcnNpb24gLWVxIDIpCiAgICBtYWtlR2xvYmFsQ29uc3RhbnQgU3VibGltZVRleHREaXJlY3RvcnkgKGVpdGhlck9yICRlbnY6U1VCTElNRV9URVhUX0RJUkVDVE9SWSAiQzpcc3QiKQogICAgbWFrZUdsb2JhbENvbnN0YW50IFN1YmxpbWVUZXh0RXhlY3V0YWJsZUhlbHBlclBhdGggKGpvaW4tcGF0aCAkU3VibGltZVRleHREaXJlY3RvcnkgJ3N1YmwuZXhlJykKICAgIG1ha2VHbG9iYWxDb25zdGFudCBTdWJsaW1lVGV4dEV4ZWN1dGFibGVQYXRoIChqb2luLXBhdGggJFN1YmxpbWVUZXh0RGlyZWN0b3J5ICdzdWJsaW1lX3RleHQuZXhlJykKICAgIG1ha2VHbG9iYWxDb25zdGFudCBTdWJsaW1lVGV4dFBhY2thZ2VzRGlyZWN0b3J5IChlaXRoZXJPciAkZW52OlNVQkxJTUVfVEVYVF9QQUNLQUdFU19ESVJFQ1RPUlkgIkM6XHN0XERhdGFcUGFja2FnZXMiKQogICAgIyBUT0RPOiBGb3IgY29tcGF0aWJpbGl0eTsgcmVtb3ZlIHdoZW4gbm90IHVzZWQgYW55bW9yZS4KICAgICRnbG9iYWw6U1RQID0gJFN1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3RvcnkKCiAgICBtYWtlR2xvYmFsQ29uc3RhbnQgUGFja2FnZVVuZGVyVGVzdE5hbWUgKGVuc3VyZVZhbHVlIChlaXRoZXJPciAkZW52OlVOSVRURVNUSU5HX1BBQ0tBR0VfVU5ERVJfVEVTVF9OQU1FICRlbnY6UEFDS0FHRSkgLW1lc3NhZ2UgInRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZSBVTklUVEVTVElOR19QQUNLQUdFX1VOREVSX1RFU1RfTkFNRSAob3IgYWx0ZXJuYXRpdmVseSwgUEFDS0FHRSkgaXMgbm90IHNldCIpCiAgICAjIFRPRE86IEZvciBjb21wYXRpYmlsaXR5OyByZW1vdmUgd2hlbiBub3QgdXNlZCBhbnltb3JlLgogICAgbWFrZUdsb2JhbENvbnN0YW50IFBhY2thZ2VOYW1lICRQYWNrYWdlVW5kZXJUZXN0TmFtZQogICAgbWFrZUdsb2JhbENvbnN0YW50IFBhY2thZ2VVbmRlclRlc3RTdWJsaW1lVGV4dFBhY2thZ2VzRGlyZWN0b3J5IChqb2luLXBhdGggJFN1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3RvcnkgJFBhY2thZ2VVbmRlclRlc3ROYW1lKQoKICAgIG1ha2VHbG9iYWxDb25zdGFudCBDb2xvclNjaGVtZVVuaXRSZXBvc2l0b3J5VXJsICJodHRwczovL2dpdGh1Yi5jb20vZ2VyYXJkcm9jaGUvc3VibGltZS1jb2xvci1zY2hlbWUtdW5pdCIKICAgIG1ha2VHbG9iYWxDb25zdGFudCBDb2xvclNjaGVtZVVuaXRTdWJsaW1lVGV4dFBhY2thZ2VzRGlyZWN0b3J5IChqb2luLXBhdGggJFN1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3RvcnkgJ0NvbG9yU2NoZW1lVW5pdCcpCiAgICBtYWtlR2xvYmFsQ29uc3RhbnQgQ292ZXJhZ2VSZXBvc2l0b3J5VXJsICJodHRwczovL2dpdGh1Yi5jb20vY29kZXhucy9zdWJsaW1lLWNvdmVyYWdlIgogICAgbWFrZUdsb2JhbENvbnN0YW50IENvdmVyYWdlU3VibGltZVRleHRQYWNrYWdlc0RpcmVjdG9yeSAoam9pbi1wYXRoICRTdWJsaW1lVGV4dFBhY2thZ2VzRGlyZWN0b3J5ICdjb3ZlcmFnZScpCiAgICBtYWtlR2xvYmFsQ29uc3RhbnQgS2V5UHJlc3NSZXBvc2l0b3J5VXJsICJodHRwczovL2dpdGh1Yi5jb20vcmFuZHkzay9LZXlwcmVzcyIKICAgIG1ha2VHbG9iYWxDb25zdGFudCBLZXlQcmVzc1N1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3RvcnkgKGpvaW4tcGF0aCAkU3VibGltZVRleHRQYWNrYWdlc0RpcmVjdG9yeSAnS2V5cHJlc3MnKQogICAgbWFrZUdsb2JhbENvbnN0YW50IFVuaXRUZXN0aW5nUmVwb3NpdG9yeVVybCAiaHR0cHM6Ly9naXRodWIuY29tL3JhbmR5M2svVW5pdFRlc3RpbmciCiAgICBtYWtlR2xvYmFsQ29uc3RhbnQgVW5pdFRlc3RpbmdTdWJsaW1lVGV4dFBhY2thZ2VzRGlyZWN0b3J5IChqb2luLXBhdGggJFN1YmxpbWVUZXh0UGFja2FnZXNEaXJlY3RvcnkgJ1VuaXRUZXN0aW5nJykKCiAgICAjIFRPRE86IElzIHRoaXMgc3BlY2lmaWMgdG8gdGhlIENJIHNlcnZpY2U/CiAgICAjIFN1cHJlc3Mgc29tZSBnaXQgd2FybmluZ3MKICAgIGdpdCBjb25maWcgLS1nbG9iYWwgYWR2aWNlLmRldGFjaGVkSGVhZCBmYWxzZQp9'
        )

    filter local:convertFromBase64String {
        param([string]$Content)
        $theContent = if ($_) { $_ } else { $Content }
        $utf8.GetString([System.Convert]::FromBase64String($theContent))
    }

    function local:createTextFile {
        param([string]$Destination, [string]$Content)
        if (![System.IO.Path]::IsPathRooted($Destination)) {
            throw "absolute path expected, got: $Destination"
        }
        if (test-path $Destination) {
            throw "cannot write file $Destination if it already exists"
        }
        [System.IO.File]::WriteAllText($Destination, $Content, $utf8)
    }

    filter local:unpackFile {
        param($Content)
        $theContent = if ($_) { $_ } else { $Content }
        $elements = @($theContent -split '@@@')
        for ($i = 0; $i -lt $elements.length; $i = $i + 2) {
            createTextFile (join-path (convert-path .) $elements[$i]) ($elements[$i+1] | convertFromBase64String)
        }
    }

    push-location $UnitTestingPowerShellScriptsDirectory
        $encodedDependencies | unpackFile
    pop-location

    . $UnitTestingPowerShellScriptsDirectory\ci_config.ps1

    $env:UNITTESTING_BOOTSTRAPPED = 1
}

# Dependencies are now available to this script.
. $UnitTestingPowerShellScriptsDirectory\utils.ps1

# logWarning "the appveyor.ps1 script is deprecated; use ci.ps1 instead"

& $UnitTestingPowerShellScriptsDirectory\ci.ps1 @PSBoundParameters
